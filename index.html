<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoShare - Cloud Native Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000000; }
        .gradient-bg { background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%); }
    </style>
</head>
<body class="bg-black">
    <div id="app"></div>

    <script>
        // API Configuration
        const API_BASE_URL = '/api';
        
        // Global state
        let currentView = 'welcome';
        let userRole = null;
        let currentTab = 'feed';
        let searchTerm = '';
        let photos = [];
        let userRatings = {};

        // API Service
        const api = {
            async request(endpoint, method = 'GET', body = null) {
                try {
                    const options = {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    };

                    if (body && method !== 'GET') {
                        options.body = JSON.stringify(body);
                    }

                    console.log(`Calling ${method} ${API_BASE_URL}${endpoint}`);
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            },

            async getPhotos() {
                return await this.request('/photos', 'GET');
            },

            async uploadPhoto(photoData) {
                return await this.request('/photos', 'POST', photoData);
            },

            async deletePhoto(photoId) {
                return await this.request(`/photos/${photoId}`, 'DELETE');
            },

            async likePhoto(photoId) {
                return await this.request(`/photos/${photoId}/like`, 'POST');
            },

            async ratePhoto(photoId, rating) {
                return await this.request(`/photos/${photoId}/rate`, 'POST', { rating });
            }
        };

        // Initialize
        async function init() {
            render();
            attachEventListeners();
        }

        function attachEventListeners() {
            const app = document.getElementById('app');
            
            app.addEventListener('click', async (e) => {
                const target = e.target;
                
                // Role selection
                if (target.dataset.role) {
                    e.preventDefault();
                    selectRole(target.dataset.role);
                }
                
                // Back to welcome
                if (target.id === 'backBtn') {
                    e.preventDefault();
                    backToWelcome();
                }
                
                // Tab buttons
                if (target.dataset.tab) {
                    e.preventDefault();
                    setTab(target.dataset.tab);
                }
                
                // Delete button
                if (target.dataset.delete) {
                    e.preventDefault();
                    await handleDelete(target.dataset.delete);
                }
                
                // Like button
                if (target.dataset.like) {
                    e.preventDefault();
                    await handleLike(target.dataset.like);
                }
                
                // Rate button
                if (target.dataset.rate) {
                    e.preventDefault();
                    await handleRate(target.dataset.rate);
                }
                
                // Upload button
                if (target.id === 'uploadBtn') {
                    e.preventDefault();
                    await handleUpload();
                }
            });
            
            app.addEventListener('change', (e) => {
                if (e.target.id === 'fileInput') {
                    handleFileSelect(e);
                }
            });
            
            app.addEventListener('input', (e) => {
                if (e.target.id === 'searchInput') {
                    handleSearch(e);
                }
            });
        }

        function render() {
            const app = document.getElementById('app');
            if (currentView === 'welcome') {
                app.innerHTML = renderWelcome();
            } else {
                app.innerHTML = renderMain();
            }
        }

        function renderWelcome() {
            return `
                <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-2xl p-8 max-w-2xl w-full">
                        <div class="text-center mb-8">
                            <div class="mb-6">
                                <svg class="w-32 h-32 mx-auto" viewBox="0 0 100 100" fill="none">
                                    <circle cx="50" cy="50" r="48" fill="#9333EA" opacity="0.1"/>
                                    <circle cx="50" cy="50" r="40" fill="#9333EA" opacity="0.2"/>
                                    <path d="M50 15L35 25V45L50 55L65 45V25L50 15Z" fill="#9333EA"/>
                                    <circle cx="50" cy="45" r="12" fill="#FFFFFF"/>
                                    <circle cx="50" cy="45" r="8" fill="#000000"/>
                                    <path d="M30 65Q50 75 70 65" stroke="#9333EA" stroke-width="3" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <h1 class="text-5xl font-bold text-white mb-3">PhotoShare</h1>
                            <p class="text-xl text-gray-400 mb-8">Cloud-Native Media Platform</p>
                            <p class="text-gray-300 mb-8">Choose how you'd like to explore PhotoShare</p>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <button data-role="creator" class="group bg-gradient-to-br from-purple-600 to-purple-800 hover:from-purple-700 hover:to-purple-900 p-8 rounded-xl transition-all transform hover:scale-105 border-2 border-purple-500">
                                <div class="text-6xl mb-4">üì∏</div>
                                <h3 class="text-2xl font-bold text-white mb-2">Creator</h3>
                                <p class="text-purple-200 text-sm">Upload and manage your photos</p>
                            </button>
                            
                            <button data-role="consumer" class="group bg-gradient-to-br from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 p-8 rounded-xl transition-all transform hover:scale-105 border-2 border-blue-500">
                                <div class="text-6xl mb-4">üîç</div>
                                <h3 class="text-2xl font-bold text-white mb-2">Consumer</h3>
                                <p class="text-blue-200 text-sm">Browse and interact with photos</p>
                            </button>
                        </div>
                        
                        <div class="mt-8 p-4 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="text-gray-400 text-sm text-center">
                                <span class="text-purple-400 font-semibold">Creators</span> can upload, manage, and delete their photos<br>
                                <span class="text-blue-400 font-semibold">Consumers</span> can browse, like, and rate all photos
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMain() {
            return `
                <div class="min-h-screen bg-black">
                    ${renderHeader()}
                    <main class="max-w-7xl mx-auto px-4 py-8">
                        ${userRole === 'creator' ? renderCreatorView() : renderConsumerView()}
                    </main>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header class="bg-gray-900 border-b border-gray-800 shadow-lg sticky top-0 z-10">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <svg class="w-10 h-10" viewBox="0 0 100 100" fill="none">
                                    <circle cx="50" cy="50" r="40" fill="#9333EA" opacity="0.2"/>
                                    <path d="M50 20L35 30V50L50 60L65 50V30L50 20Z" fill="#9333EA"/>
                                    <circle cx="50" cy="50" r="12" fill="#FFFFFF"/>
                                </svg>
                                <div>
                                    <h1 class="text-2xl font-bold text-white">PhotoShare</h1>
                                    <p class="text-xs ${userRole === 'creator' ? 'text-purple-400' : 'text-blue-400'}">${userRole.toUpperCase()} MODE</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-sm text-gray-400">You are a <span class="font-semibold ${userRole === 'creator' ? 'text-purple-400' : 'text-blue-400'}">${userRole}</span></span>
                                <button id="backBtn" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors">Change Role</button>
                            </div>
                        </div>
                        ${userRole === 'creator' ? `
                        <div class="flex gap-2 mt-4 border-t border-gray-800 pt-4">
                            <button data-tab="feed" class="px-4 py-2 rounded-lg transition-colors ${currentTab==='feed'?'bg-purple-600 text-white':'bg-gray-800 text-gray-300 hover:bg-gray-700'}">All Photos</button>
                            <button data-tab="upload" class="px-4 py-2 rounded-lg transition-colors ${currentTab==='upload'?'bg-purple-600 text-white':'bg-gray-800 text-gray-300 hover:bg-gray-700'}">Upload New</button>
                        </div>` : ''}
                    </div>
                </header>
            `;
        }

        function renderCreatorView() {
            if (currentTab === 'upload') {
                return `
                    <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-lg p-6 max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold text-white mb-6">üì§ Upload New Photo</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block font-medium text-gray-300 mb-2">Select Image</label>
                                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-700 rounded-lg cursor-pointer bg-gray-800 hover:bg-gray-750 transition-colors">
                                    <div class="text-center">
                                        <p class="text-sm text-gray-400">Click to upload image</p>
                                        <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF up to 10MB</p>
                                    </div>
                                    <input id="fileInput" type="file" accept="image/*" class="hidden">
                                </label>
                                <img id="preview" class="mt-3 w-full h-48 object-cover rounded-lg border border-gray-700 hidden">
                            </div>
                            <input type="text" id="title" placeholder="Photo Title *" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-purple-600 focus:outline-none">
                            <textarea id="caption" placeholder="Caption (optional)" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-purple-600 focus:outline-none" rows="3"></textarea>
                            <input type="text" id="location" placeholder="Location (optional)" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-purple-600 focus:outline-none">
                            <input type="text" id="tags" placeholder="Tags: nature, sunset, travel" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-purple-600 focus:outline-none">
                            <button id="uploadBtn" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold transition-colors">Upload Photo</button>
                        </div>
                    </div>
                `;
            }
            return `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">All Photos (${photos.length})</h2>
                        <button data-tab="upload" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-colors">+ Upload Photo</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${photos.length > 0 ? photos.map(p => renderPhotoCard(p, false)).join('') : '<p class="text-gray-400 col-span-3 text-center py-12">No photos yet. Upload your first photo!</p>'}
                    </div>
                </div>
            `;
        }

        function renderConsumerView() {
            const filtered = photos.filter(p => 
                p.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
                p.tags.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (p.location && p.location.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            return `
                <div>
                    <div class="mb-6">
                        <input type="text" id="searchInput" value="${searchTerm}" placeholder="üîç Search photos by title, tags, or location..." class="w-full px-4 py-3 bg-gray-900 border border-gray-800 text-white rounded-lg focus:ring-2 focus:ring-blue-600 focus:outline-none">
                    </div>
                    <div class="mb-4">
                        <h2 class="text-xl text-gray-400">Found ${filtered.length} photo${filtered.length !== 1 ? 's' : ''}</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${filtered.length > 0 ? filtered.map(p => renderPhotoCard(p, true)).join('') : '<p class="text-gray-400 col-span-3 text-center py-12">No photos found. Try a different search term.</p>'}
                    </div>
                </div>
            `;
        }

        function renderPhotoCard(p, isConsumer) {
            return `
                <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-lg overflow-hidden hover:border-${isConsumer ? 'blue' : 'purple'}-600 transition-colors">
                    <div class="relative">
                        <img src="${p.url}" alt="${p.title}" class="w-full h-64 object-cover">
                        ${userRole === 'creator' ? `<button data-delete="${p.id}" class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm font-medium shadow-lg">üóëÔ∏è Delete</button>` : ''}
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg text-white">${p.title}</h3>
                        <p class="text-sm text-gray-400 mb-2">üìÖ ${new Date(p.uploadedAt).toLocaleDateString()}</p>
                        ${p.caption ? `<p class="text-gray-300 mt-2 text-sm">${p.caption}</p>` : ''}
                        ${p.location ? `<p class="text-sm text-gray-400 mt-2">üìç ${p.location}</p>` : ''}
                        ${p.tags ? `<div class="flex flex-wrap gap-1 mt-2">${p.tags.split(',').map(tag => `<span class="text-xs px-2 py-1 bg-purple-900/50 text-purple-300 rounded">#${tag.trim()}</span>`).join('')}</div>` : ''}
                        ${isConsumer ? `
                        <div class="flex gap-4 pt-3 border-t border-gray-800 mt-3">
                            <button data-like="${p.id}" class="flex items-center gap-1 text-gray-400 hover:text-red-500 transition-colors">
                                ‚ù§Ô∏è <span class="text-sm">${p.likes}</span>
                            </button>
                            ${userRatings[p.id] ? 
                                `<span class="flex items-center gap-1 text-yellow-500 text-sm">‚≠ê Rated ${userRatings[p.id]}/5</span>` : 
                                `<button data-rate="${p.id}" class="flex items-center gap-1 text-gray-400 hover:text-yellow-500 transition-colors text-sm">‚≠ê Rate</button>`
                            }
                            ${p.ratingCount > 0 ? `<span class="text-gray-500 text-sm">‚≠ê ${p.rating.toFixed(1)} (${p.ratingCount})</span>` : ''}
                        </div>` : `
                        <div class="flex gap-4 pt-3 border-t border-gray-800 mt-3 text-sm text-gray-400">
                            <span class="flex items-center gap-1">‚ù§Ô∏è ${p.likes}</span>
                            ${p.ratingCount > 0 ? `<span class="flex items-center gap-1">‚≠ê ${p.rating.toFixed(1)} (${p.ratingCount})</span>` : ''}
                        </div>`}
                    </div>
                </div>
            `;
        }

        // Event Handlers
        async function selectRole(role) {
            userRole = role;
            currentView = 'main';
            await loadPhotos();
            render();
        }

        function backToWelcome() {
            userRole = null;
            currentView = 'welcome';
            currentTab = 'feed';
            searchTerm = '';
            render();
        }

        function setTab(tab) {
            currentTab = tab;
            render();
        }

        function handleSearch(event) {
            searchTerm = event.target.value;
            render();
        }

        let selectedFile = null;
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('preview').src = e.target.result;
                    document.getElementById('preview').classList.remove('hidden');
                };
                reader.readAsDataURL(selectedFile);
            }
        }

        async function handleUpload() {
            const title = document.getElementById('title').value;
            
            console.log('Upload clicked');
            console.log('Title:', title);
            console.log('Selected file:', selectedFile);
            
            if (!title || !title.trim()) {
                alert('‚ö†Ô∏è Please enter a title for your photo');
                return;
            }
            
            if (!selectedFile) {
                alert('‚ö†Ô∏è Please select an image file');
                return;
            }

            // Show loading state
            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.textContent;
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Uploading...';

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        console.log('File read complete, sending to server...');
                        
                        const photoData = {
                            title: title.trim(),
                            caption: document.getElementById('caption').value || '',
                            location: document.getElementById('location').value || '',
                            tags: document.getElementById('tags').value || '',
                            imageData: e.target.result,
                            fileName: selectedFile.name
                        };

                        console.log('Uploading photo data:', {
                            title: photoData.title,
                            fileName: photoData.fileName,
                            dataLength: photoData.imageData.length
                        });

                        const newPhoto = await api.uploadPhoto(photoData);
                        console.log('Photo uploaded successfully:', newPhoto);
                        
                        photos.unshift(newPhoto);
                        currentTab = 'feed';
                        selectedFile = null;
                        
                        // Clear form
                        document.getElementById('title').value = '';
                        document.getElementById('caption').value = '';
                        document.getElementById('location').value = '';
                        document.getElementById('tags').value = '';
                        
                        render();
                        alert('‚úÖ Photo uploaded successfully!');
                    } catch (uploadError) {
                        console.error('Upload error:', uploadError);
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = originalText;
                        alert('‚ùå Upload failed: ' + uploadError.message);
                    }
                };
                
                reader.onerror = (error) => {
                    console.error('File read error:', error);
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = originalText;
                    alert('‚ùå Failed to read file');
                };
                
                reader.readAsDataURL(selectedFile);
            } catch (error) {
                console.error('Upload error:', error);
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
                alert('‚ùå Upload failed: ' + error.message);
            }
        }

        async function handleDelete(photoId) {
            if (!confirm('Are you sure you want to delete this photo?')) return;
            
            try {
                await api.deletePhoto(photoId);
                photos = photos.filter(p => p.id !== photoId);
                render();
                alert('‚úÖ Photo deleted successfully!');
            } catch (error) {
                alert('‚ùå Delete failed: ' + error.message);
            }
        }

        async function handleLike(photoId) {
            try {
                await api.likePhoto(photoId);
                const photo = photos.find(p => p.id === photoId);
                if (photo) photo.likes++;
                render();
            } catch (error) {
                alert('‚ùå Like failed: ' + error.message);
            }
        }

        async function handleRate(photoId) {
            if (userRatings[photoId]) {
                alert('You have already rated this photo!');
                return;
            }

            const rating = prompt('Rate this photo (1-5 stars):');
            if (!rating || rating < 1 || rating > 5) {
                alert('Please enter a rating between 1 and 5');
                return;
            }

            try {
                await api.ratePhoto(photoId, parseInt(rating));
                userRatings[photoId] = parseInt(rating);
                const photo = photos.find(p => p.id === photoId);
                if (photo) {
                    photo.rating = ((photo.rating * photo.ratingCount) + parseInt(rating)) / (photo.ratingCount + 1);
                    photo.ratingCount++;
                }
                render();
                alert('‚úÖ Thank you for rating!');
            } catch (error) {
                alert('‚ùå Rating failed: ' + error.message);
            }
        }

        async function loadPhotos() {
            try {
                photos = await api.getPhotos();
                render();
            } catch (error) {
                console.error('Failed to load photos:', error);
                photos = [];
            }
        }

        // Initialize app
        init();
    </script>
</body>
</html>
